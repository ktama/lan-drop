name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal

  release:
    runs-on: windows-latest
    needs: build-and-test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Publish (Windows x64)
        run: |
          dotnet publish src/LanDrop/LanDrop.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-x64

      - name: Publish (Windows x86)
        run: |
          dotnet publish src/LanDrop/LanDrop.csproj -c Release -r win-x86 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-x86

      - name: Publish (Windows ARM64)
        run: |
          dotnet publish src/LanDrop/LanDrop.csproj -c Release -r win-arm64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-arm64

      - name: Create ZIP archives
        shell: pwsh
        run: |
          Compress-Archive -Path publish/win-x64/* -DestinationPath lan-drop-${{ steps.version.outputs.VERSION }}-win-x64.zip
          Compress-Archive -Path publish/win-x86/* -DestinationPath lan-drop-${{ steps.version.outputs.VERSION }}-win-x86.zip
          Compress-Archive -Path publish/win-arm64/* -DestinationPath lan-drop-${{ steps.version.outputs.VERSION }}-win-arm64.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: LAN Drop v${{ steps.version.outputs.VERSION }}
          body: |
            ## LAN Drop v${{ steps.version.outputs.VERSION }}
            
            ### ダウンロード
            
            | プラットフォーム | ファイル |
            |-----------------|---------|
            | Windows x64 | `lan-drop-${{ steps.version.outputs.VERSION }}-win-x64.zip` |
            | Windows x86 | `lan-drop-${{ steps.version.outputs.VERSION }}-win-x86.zip` |
            | Windows ARM64 | `lan-drop-${{ steps.version.outputs.VERSION }}-win-arm64.zip` |
            
            ### 使用方法
            
            1. ZIPファイルをダウンロードして展開
            2. `lan-drop.exe` を実行
            3. 表示されたURLを共有相手に伝える
            
            詳細は [README](https://github.com/${{ github.repository }}/blob/main/README.md) を参照してください。
          files: |
            lan-drop-${{ steps.version.outputs.VERSION }}-win-x64.zip
            lan-drop-${{ steps.version.outputs.VERSION }}-win-x86.zip
            lan-drop-${{ steps.version.outputs.VERSION }}-win-arm64.zip
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
